version: '3'

tasks:
  generate:
    desc: Generate random secrets to .env file
    cmds:
      - |
        cat > .env << 'EOFENV'
        # Homelab Secrets (generated $(date +%Y-%m-%d))
        SECRET_KEY=$(openssl rand -base64 32)
        ADMIN_USER=admin
        ADMIN_PASSWORD=$(openssl rand -base64 16)
        KEYCLOAK_ADMIN=admin
        KEYCLOAK_ADMIN_PASSWORD=$(openssl rand -base64 16)
        KEYCLOAK_CLIENT_SECRET=$(openssl rand -base64 32)
        KEYCLOAK_M2M_CLIENT_ID=mcp-gateway-m2m
        KEYCLOAK_M2M_CLIENT_SECRET=$(openssl rand -base64 32)
        KEYCLOAK_DB_PASSWORD=$(openssl rand -base64 16)
        METRICS_API_KEY_AUTH_SERVER=$(openssl rand -base64 32)
        METRICS_API_KEY_REGISTRY=$(openssl rand -base64 32)
        METRICS_API_KEY_MCPGW_SERVER=$(openssl rand -base64 32)
        EOFENV
      - echo "✓ Generated .env with random secrets"
    status:
      - test -f .env
    generates:
      - .env

  apply:
    desc: Create k8s secret from .env file
    cmds:
      - kubectl create secret generic homelab-secrets --from-env-file=.env -n {{.NAMESPACE}} --dry-run=client -o yaml | kubectl apply -f -
      - echo "✓ Secrets applied to cluster"
    preconditions:
      - sh: test -f .env
        msg: ".env file not found. Run 'task secrets:generate' first."
      - sh: kubectl get namespace {{.NAMESPACE}} 2>/dev/null
        msg: "Namespace {{.NAMESPACE}} not found. Deploy namespace first."

  show:
    desc: Show current secret keys (not values)
    cmds:
      - kubectl get secret homelab-secrets -n {{.NAMESPACE}} -o jsonpath='{.data}' | jq -r 'keys[]'
