version: '3'

# Shell options for better error handling
set: [errexit, pipefail]
shopt: [globstar]

# Suppress command echo by default
silent: true

# Output mode: prefixed for parallel tasks
output: prefixed

# Global variables available to all included taskfiles
vars:
  CLUSTER_NAME: homelab
  NAMESPACE: homelab
  REGISTRY_PORT: 5001
  REGISTRY_NAME: registry.localhost
  REFERENCE_DIR: ../references/mcp-gateway-registry
  IMAGE_PREFIX: "{{.REGISTRY_NAME}}:{{.REGISTRY_PORT}}/mcp-gateway-registry"

env:
  PATH:
    sh: echo "/opt/homebrew/bin:$PATH"
  KUBECONFIG:
    sh: echo "${KUBECONFIG:-$HOME/.kube/config}"

# Load secrets from .env if it exists
dotenv: ['.env']

# Include modular taskfiles
includes:
  cluster:
    taskfile: ./tasks/cluster.yml
    aliases: [c]
  build:
    taskfile: ./tasks/build.yml
    aliases: [b]
  secrets:
    taskfile: ./tasks/secrets.yml
    aliases: [s]
  deploy:
    taskfile: ./tasks/deploy.yml
    aliases: [d]
  logs:
    taskfile: ./tasks/logs.yml
    aliases: [l]
  test:
    taskfile: ./tasks/test.yml
    aliases: [t]
  argocd:
    taskfile: ./tasks/argocd.yml
    aliases: [a]

tasks:
  # === Default ===
  default:
    desc: Show available tasks
    cmds:
      - task --list
    silent: false

  # === Orchestration (top-level convenience tasks) ===
  up:
    desc: Full platform startup (cluster + build + deploy)
    summary: |
      Complete platform bootstrap:
      1. Creates k3d cluster (if not exists)
      2. Builds all container images
      3. Deploys to cluster
      4. Runs health checks
    cmds:
      - task: cluster:create
      - task: build:all
      - task: deploy
      - task: status

  down:
    desc: Full platform shutdown
    cmds:
      - task: deploy:undeploy
      - task: cluster:stop

  restart:
    desc: Restart all deployments
    cmds:
      - kubectl rollout restart deployment -n {{.NAMESPACE}}
      - task: wait:ready

  # === Status & Monitoring ===
  status:
    desc: Show platform status
    cmds:
      - echo "=== Pods ==="
      - kubectl get pods -n {{.NAMESPACE}} -o wide
      - echo ""
      - echo "=== Ingress ==="
      - kubectl get ingress -n {{.NAMESPACE}}
      - echo ""
      - 'echo "=== URLs ==="'
      - 'echo "  Registry:  https://mcp-registry.127-0-0-1.sslip.io"'
      - 'echo "  Auth:      https://mcp-auth.127-0-0-1.sslip.io"'
      - 'echo "  Keycloak:  https://keycloak.127-0-0-1.sslip.io"'
      - 'echo "  Metrics:   https://mcp-metrics.127-0-0-1.sslip.io"'
      - 'echo "  ArgoCD:    https://argocd.127-0-0-1.sslip.io"'
      - 'echo "  Gitea:     https://gitea.127-0-0-1.sslip.io"'
    silent: false

  wait:ready:
    desc: Wait for all pods to be ready
    cmds:
      - echo "Waiting for pods to be ready..."
      - kubectl wait --for=condition=ready pod -l app.kubernetes.io/part-of={{.NAMESPACE}} -n {{.NAMESPACE}} --timeout=300s
      - echo "✓ All pods ready"
    ignore_error: true

  # === Development ===
  shell:registry:
    desc: Shell into registry pod
    cmds:
      - kubectl exec -it -n {{.NAMESPACE}} deployment/registry -- /bin/sh
    interactive: true

  shell:auth:
    desc: Shell into auth-server pod
    cmds:
      - kubectl exec -it -n {{.NAMESPACE}} deployment/auth-server -- /bin/sh
    interactive: true

  shell:keycloak:
    desc: Shell into keycloak pod
    cmds:
      - kubectl exec -it -n {{.NAMESPACE}} deployment/keycloak -- /bin/bash
    interactive: true

  describe:
    desc: Describe all deployments
    cmds:
      - for:
          - registry
          - auth-server
          - keycloak
          - metrics-service
        cmd: |
          echo "=== {{.ITEM}} ===" && kubectl describe deployment/{{.ITEM}} -n {{.NAMESPACE}} | /usr/bin/head -30
    silent: false

  # === Cleanup ===
  clean:
    desc: Full cleanup - delete cluster and images
    prompt: This will destroy everything. Are you sure?
    cmds:
      - task: cluster:delete
      - for:
          - registry
          - auth-server
          - metrics-service
        cmd: docker rmi {{.IMAGE_PREFIX}}/{{.ITEM}}:latest 2>/dev/null || true
      - echo "✓ Cleanup complete"
    ignore_error: true

  clean:images:
    desc: Remove local docker images only
    cmds:
      - for:
          - registry
          - auth-server
          - metrics-service
        cmd: docker rmi {{.IMAGE_PREFIX}}/{{.ITEM}}:latest 2>/dev/null || true
    ignore_error: true

  # === Utilities ===
  info:
    desc: Show cluster and environment info
    cmds:
      - echo "=== Cluster Info ==="
      - kubectl cluster-info
      - echo ""
      - echo "=== Nodes ==="
      - kubectl get nodes
      - echo ""
      - echo "=== Registry ==="
      - echo "Push to {{.IMAGE_PREFIX}}/<image>:latest"
    silent: false

  ctx:
    desc: Switch kubectl context to homelab
    cmds:
      - kubectl config use-context k3d-{{.CLUSTER_NAME}}

  # === GitOps ===
  push:
    desc: Commit and push to Gitea (triggers ArgoCD sync)
    cmds:
      - git add -A
      - git commit -m "{{.CLI_ARGS}}" || echo "Nothing to commit"
      - git push origin main
      - echo "✓ Pushed to Gitea - ArgoCD will sync automatically"

  mirror:
    desc: Push to GitHub mirror
    cmds:
      - git push github main
      - echo "✓ Mirrored to GitHub"

  push:all:
    desc: Push to both Gitea and GitHub
    cmds:
      - task: push
        vars: { CLI_ARGS: "{{.CLI_ARGS}}" }
      - task: mirror
